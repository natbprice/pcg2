---
title: "Example"
author: "Nathaniel Price"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```




```{r, warning = FALSE}
library(tvdiff)
library(tidyr)
library(dplyr)
library(ggplot2)

# Load demo data
data("smalldemodata")

# Build dataframe
smallEx <-
  smalldemodata %>%
  # Estimate derivative
  mutate(dxdt =
           TVRegDiffR(
             data = obs,
             iter = 1e3,
             alph = 0.2,
             scale = "small",
             ep = 1e-6,
             dx = 0.01
           )[-1]) %>% 
  # Simple numerical integration
  mutate(dx = lead(x) - x,
         pred = obs[1] + cumsum(dxdt*dx),
         true = abs(x - 0.5)) %>% 
  # Collect in long form
  gather(key, value, -x, -dx)

# Plot observed vs predicted
ggplot(smallEx %>% 
         filter(key != "dxdt"), 
       aes(x = x, y = value, color = key, linetype = key)) +
  geom_line(size = 1.1)

# Plot derivative
ggplot(smallEx %>% 
         filter(key == "dxdt"), 
       aes(x = x, y = value)) +
  geom_point()

```

```{r}

# Load data
data("largedemodata")

# Build dataframe
largeEx <-
  largedemodata %>%
  slice(seq(1, n(), 1e2)) %>% 
  # Estimate derivative
  mutate(dxdt =
           TVRegDiffR(
             data = obs,
             iter = 40L,
             alph = 1e3,
             scale = "large",
             ep = 1e-6,
             dx = 100
           )) %>% 
  # Simple numerical integration
  mutate(dx = lead(x) - x,
         pred = obs[1] + cumsum(dxdt*dx)) %>% 
  # Collect in long form
  gather(key, value, -x, -dx)

# Plot observed vs predicted
ggplot(largeEx %>% 
         filter(key != "dxdt"), 
       aes(x = x, y = value, color = key, linetype = key)) +
  geom_line(size = 1.2)

# Plot derivative
ggplot(largeEx %>% 
         filter(key == "dxdt"), 
       aes(x = x, y = value)) +
  geom_point()


```

```{r}

# Load data
data("paleoDistance")

xout <- seq(min(paleoDistance$sortVar), max(paleoDistance$sortVar), length.out = 700)

# Build dataframe
paleoEx <-
  paleoDistance %>%
  select(-cellID) %>% 
  rename(t = sortVar) %>% 
  nest() %>% 
  mutate(
    t = purrr::map(data, ~ approx(.$t, .$s, xout = xout)$x, rule = 1),
    s = purrr::map(data, ~ approx(.$t, .$s, xout = xout)$y, rule = 1)
  ) %>%
  dplyr::select(-data) %>%
  unnest() %>% 
  mutate(dt = lead(t) - t) %>% 
  # Estimate derivative
  mutate(dsdt.tvdiff =
           TVRegDiffR(
             data = s,
             iter = 40L,
             alph = 100,
             scale = "large",
             ep = 1e-6,
             dx = dt[1]
           )) %>% 
  # Simple numerical integration
  mutate(pred = s[1] + cumsum(dsdt.tvdiff*dt)) %>% 
  # Collect in long form
  gather(key, value, -t, -dt)

# Plot observed vs predicted
ggplot(paleoEx %>% 
         filter(key %in% c("s", "pred")), 
       aes(x = t, y = value, color = key, linetype = key)) +
  geom_line(size = 1.2)

# Plot derivative
ggplot(paleoEx %>% 
         filter(key %in% c("dsdt", "dsdt.tvdiff")), 
       aes(x = t, y = value, color = key)) +
  geom_point()


```


